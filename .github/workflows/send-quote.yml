name: Send Daily Quote

on:
  schedule:
    # Run every 15 minutes for testing (temporary)
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  send-quote:
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate and Send Quote
        run: |
          # Generate a new quote
          echo "Generating quote from ${{ secrets.BACKEND_URL }}/api/quotes/generate"
          
          GENERATE_RESPONSE=$(curl -w "HTTP_STATUS:%{http_code}" -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${{ secrets.API_SECRET_KEY }}" \
            "${{ secrets.BACKEND_URL }}/api/quotes/generate?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}")
          
          HTTP_STATUS=$(echo "$GENERATE_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
          GENERATE_BODY=$(echo "$GENERATE_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
          
          echo "Generate HTTP Status: $HTTP_STATUS"
          echo "Generate response: $GENERATE_BODY"
          
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "Generate API failed with status: $HTTP_STATUS"
            exit 1
          fi
          
          if [ -z "$GENERATE_BODY" ]; then
            echo "Empty response from generate API"
            exit 1
          fi
          
          # Extract quote ID from response
          QUOTE_ID=$(echo "$GENERATE_BODY" | jq -r '.quote.id // null')
          QUOTE_TEXT=$(echo "$GENERATE_BODY" | jq -r '.quote.text // ""')
          QUOTE_AUTHOR=$(echo "$GENERATE_BODY" | jq -r '.quote.author // ""')
          QUOTE_BIOGRAPHY=$(echo "$GENERATE_BODY" | jq -r '.quote.biography // ""')
          
          echo "Quote ID: $QUOTE_ID"
          echo "Quote Text: $QUOTE_TEXT"
          
          if [ "$QUOTE_ID" != "null" ] && [ -n "$QUOTE_ID" ]; then
            # Send the quote to all users
            echo "Sending quote to devices..."
            SEND_RESPONSE=$(curl -w "HTTP_STATUS:%{http_code}" -s -X POST \
              -H "Content-Type: application/json" \
              -H "x-api-key: ${{ secrets.API_SECRET_KEY }}" \
              -d "{
                \"quoteId\": $QUOTE_ID,
                \"quote\": {
                  \"text\": \"$QUOTE_TEXT\",
                  \"author\": \"$QUOTE_AUTHOR\",
                  \"biography\": \"$QUOTE_BIOGRAPHY\"
                }
              }" \
              "${{ secrets.BACKEND_URL }}/api/quotes/send?x-vercel-set-bypass-cookie=true&x-vercel-protection-bypass=${{ secrets.VERCEL_AUTOMATION_BYPASS_SECRET }}"
            
            SEND_HTTP_STATUS=$(echo "$SEND_RESPONSE" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
            SEND_BODY=$(echo "$SEND_RESPONSE" | sed 's/HTTP_STATUS:[0-9]*$//')
            
            echo "Send HTTP Status: $SEND_HTTP_STATUS"
            echo "Send response: $SEND_BODY"
            
            if [ "$SEND_HTTP_STATUS" = "200" ]; then
              # Extract success info
              SUCCESS_COUNT=$(echo "$SEND_BODY" | jq -r '.successCount // 0')
              RECIPIENT_COUNT=$(echo "$SEND_BODY" | jq -r '.recipientCount // 0')
              
              echo "✅ Quote sent successfully to $SUCCESS_COUNT of $RECIPIENT_COUNT devices"
            else
              echo "❌ Failed to send quote. HTTP Status: $SEND_HTTP_STATUS"
              exit 1
            fi
          else
            echo "❌ Failed to generate quote - invalid quote ID: $QUOTE_ID"
            exit 1
          fi